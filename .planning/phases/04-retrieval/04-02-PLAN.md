---
phase: 04-retrieval
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/thehook/cli.py
  - tests/test_retrieve.py
autonomous: true
requirements: [RETR-03, RETR-04]

must_haves:
  truths:
    - "Running 'thehook retrieve' reads stdin and outputs hookSpecificOutput JSON"
    - "Running 'thehook recall <query>' prints matching knowledge to the terminal"
    - "Running 'thehook recall <query>' prints 'No relevant knowledge found.' when collection is empty"
  artifacts:
    - path: "src/thehook/cli.py"
      provides: "retrieve and recall CLI subcommands"
      contains: "def retrieve"
    - path: "src/thehook/cli.py"
      provides: "recall CLI subcommand"
      contains: "def recall"
  key_links:
    - from: "src/thehook/cli.py"
      to: "src/thehook/retrieve.py"
      via: "lazy import of run_retrieve, query_sessions, format_context"
      pattern: "from thehook\\.retrieve import"
    - from: "src/thehook/init.py"
      to: "src/thehook/cli.py"
      via: "HOOK_CONFIG references 'thehook retrieve' command"
      pattern: "thehook retrieve"
---

<objective>
Wire the `thehook retrieve` and `thehook recall` CLI subcommands into `cli.py`, completing the user-facing interface for the retrieval phase.

Purpose: The retrieve module (Plan 01) provides the functions; this plan makes them accessible via the CLI. `retrieve` is called by the SessionStart hook; `recall` is invoked directly by the user for on-demand search.

Output: Updated `cli.py` with two new subcommands; integration tests verifying CLI behavior.
</objective>

<execution_context>
@/Users/louisbarbier/.claude/get-shit-done/workflows/execute-plan.md
@/Users/louisbarbier/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-retrieval/04-RESEARCH.md
@.planning/phases/04-retrieval/04-01-SUMMARY.md

@src/thehook/cli.py
@src/thehook/retrieve.py
@src/thehook/init.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retrieve and recall CLI subcommands</name>
  <files>src/thehook/cli.py</files>
  <action>
Add two new subcommands to `cli.py` following the exact pattern established by `capture` and `reindex`:

**`retrieve` subcommand** (called by SessionStart hook via `thehook retrieve`):

```python
@main.command()
def retrieve():
    """Inject relevant context into a new Claude Code session (called by SessionStart hook)."""
    from thehook.retrieve import run_retrieve
    run_retrieve()
```

- No options or arguments — all input comes from stdin (hook input JSON), exactly like `capture`.
- The `thehook retrieve` command string is already registered in `HOOK_CONFIG` in `init.py` from Phase 1. This plan does NOT touch `init.py`.
- Lazy import of `run_retrieve` inside the command function — consistent with all existing CLI commands.

**`recall` subcommand** (user-invoked for on-demand search):

```python
@main.command()
@click.argument("query")
@click.option("--path", default=".", help="Project root directory")
def recall(query, path):
    """Search stored knowledge for QUERY and print matching results."""
    from thehook.retrieve import query_sessions, format_context
    from thehook.config import load_config
    project_dir = Path(path).resolve()
    config = load_config(project_dir)
    token_budget = config.get("token_budget", 2000)
    documents = query_sessions(project_dir, query_text=query)
    if not documents:
        click.echo("No relevant knowledge found.")
        return
    click.echo(format_context(documents, token_budget=token_budget))
```

- `query` is a positional argument (Click `@click.argument`), not an option.
- `--path` option mirrors `reindex` and `init` commands for project root directory.
- Lazy import of `query_sessions`, `format_context` from `retrieve.py` and `load_config` from `config.py`.
- Token budget loaded from config (respects `thehook.yaml` overrides).
- Prints "No relevant knowledge found." and returns when no documents match — user-friendly feedback.
- Prints the formatted context string (same `format_context()` output) when results found.
  </action>
  <verify>
    <automated>python -c "from thehook.cli import main; print([cmd.name for cmd in main.commands.values()])"</automated>
    <manual>Verify output includes 'retrieve' and 'recall' alongside existing commands</manual>
    <sampling_rate>run after this task commits</sampling_rate>
  </verify>
  <done>
    - `thehook retrieve` subcommand registered and callable
    - `thehook recall <query>` subcommand registered with positional argument and --path option
    - Both use lazy imports from retrieve.py
    - recall loads token_budget from config
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI integration tests for retrieve and recall</name>
  <files>tests/test_retrieve.py</files>
  <action>
Append integration tests to the existing `tests/test_retrieve.py` (created in Plan 01) using Click's `CliRunner` to test the CLI subcommands end-to-end.

**Tests to add:**

1. `test_cli_retrieve_command` (integration):
   - Use `CliRunner` with input providing a JSON hook input string via stdin: `{"cwd": str(tmp_path), "session_id": "test123"}`
   - Create `.thehook/chromadb/` in tmp_path
   - Index a test session file first using `index_session_file()`
   - Invoke `main` with `["retrieve"]` and stdin input
   - Assert exit code is 0
   - Parse result.output as JSON
   - Assert `hookSpecificOutput.additionalContext` is present and non-empty

2. `test_cli_retrieve_no_collection` (integration):
   - Use `CliRunner` with input providing `{"cwd": str(tmp_path)}`
   - Create `.thehook/chromadb/` but do NOT index anything
   - Invoke `main` with `["retrieve"]` and stdin input
   - Assert exit code is 0
   - Assert result.output is empty (no JSON printed when no context)

3. `test_cli_recall_prints_results` (integration):
   - Create `.thehook/sessions/` and `.thehook/chromadb/` in tmp_path
   - Write a session markdown file and index it via `index_session_file()`
   - Invoke `main` with `["recall", "conventions", "--path", str(tmp_path)]`
   - Assert exit code is 0
   - Assert result.output contains content from the indexed document

4. `test_cli_recall_empty_collection` (integration):
   - Create `.thehook/chromadb/` in tmp_path
   - Invoke `main` with `["recall", "anything", "--path", str(tmp_path)]`
   - Assert exit code is 0
   - Assert result.output contains "No relevant knowledge found."

**Test setup pattern** (mirror existing test_capture.py patterns):
- Use `tmp_path` fixture for isolated project directories
- Use `CliRunner(mix_stderr=False)` to separate stdout from stderr
- Create necessary `.thehook/` subdirectories before each test
- Write minimal session files with valid frontmatter for indexing tests

**Important:** For the `retrieve` command tests, `CliRunner` passes stdin via the `input` parameter:
```python
runner = CliRunner(mix_stderr=False)
result = runner.invoke(main, ["retrieve"], input='{"cwd": "/path/to/project"}')
```

Run: `pytest tests/test_retrieve.py -x` — all tests (9 from Plan 01 + 4 new) must pass.
Run: `pytest tests/ -x` — full suite must pass with no regressions.
  </action>
  <verify>
    <automated>pytest tests/test_retrieve.py -x</automated>
    <manual>Verify 13 total tests in test_retrieve.py (9 unit + 4 CLI integration)</manual>
    <sampling_rate>run after this task commits, then full suite before plan completion</sampling_rate>
  </verify>
  <done>
    - 4 new CLI integration tests pass
    - Full test suite (63+ tests) passes with no regressions
    - `thehook retrieve` produces valid JSON on stdout when context exists
    - `thehook retrieve` produces no output when collection is empty
    - `thehook recall <query>` prints matching documents
    - `thehook recall <query>` prints "No relevant knowledge found." on empty collection
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_retrieve.py -x` — all 13 tests pass (9 unit + 4 CLI)
2. `pytest tests/ -x` — full suite passes (54 existing + 13 new = 67+ tests)
3. `thehook --help` shows retrieve and recall commands
4. CLI commands follow established patterns (lazy imports, --path option on recall)
5. HOOK_CONFIG in init.py references `thehook retrieve` — already wired from Phase 1
</verification>

<success_criteria>
- `thehook retrieve` CLI subcommand works end-to-end (stdin JSON -> stdout JSON)
- `thehook recall <query>` CLI subcommand works end-to-end (query -> printed results)
- Both commands use lazy imports
- recall respects token_budget from config
- 4 CLI integration tests pass
- Full test suite green with no regressions
- The SessionStart hook pipeline is fully wired: `thehook retrieve` (CLI) -> `run_retrieve()` -> `query_sessions()` -> ChromaDB -> `format_context()` -> stdout JSON
</success_criteria>

<output>
After completion, create `.planning/phases/04-retrieval/04-02-SUMMARY.md`
</output>
