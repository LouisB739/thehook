---
phase: 04-retrieval
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/thehook/retrieve.py
  - tests/test_retrieve.py
autonomous: true
requirements: [RETR-01, RETR-02, RETR-03]

must_haves:
  truths:
    - "query_sessions() returns matching document strings from ChromaDB"
    - "query_sessions() returns empty list when collection is empty or missing"
    - "format_context() assembles documents into a single string capped at token_budget"
    - "run_retrieve() reads hook stdin, queries ChromaDB, and prints valid hookSpecificOutput JSON to stdout"
    - "run_retrieve() prints nothing when no context is found"
    - "run_retrieve() reads token_budget from config"
  artifacts:
    - path: "src/thehook/retrieve.py"
      provides: "query_sessions, format_context, run_retrieve"
      exports: ["query_sessions", "format_context", "run_retrieve"]
    - path: "tests/test_retrieve.py"
      provides: "TDD tests covering RETR-01, RETR-02, RETR-03"
      min_lines: 80
  key_links:
    - from: "src/thehook/retrieve.py"
      to: "src/thehook/storage.py"
      via: "lazy import of get_chroma_client, COLLECTION_NAME"
      pattern: "from thehook\\.storage import"
    - from: "src/thehook/retrieve.py"
      to: "src/thehook/capture.py"
      via: "import read_hook_input"
      pattern: "from thehook\\.capture import read_hook_input"
    - from: "src/thehook/retrieve.py"
      to: "src/thehook/config.py"
      via: "import load_config for token_budget"
      pattern: "from thehook\\.config import load_config"
---

<objective>
Build the retrieval module (`retrieve.py`) with TDD: `query_sessions()` for ChromaDB similarity search, `format_context()` for token-budgeted assembly, and `run_retrieve()` for the SessionStart hook pipeline.

Purpose: This module closes the memory loop by providing the core retrieval functions that both the SessionStart hook and the `recall` CLI command will use. All three functions have well-defined I/O contracts suitable for test-first development.

Output: `src/thehook/retrieve.py` with three tested functions; `tests/test_retrieve.py` with comprehensive TDD tests.
</objective>

<execution_context>
@/Users/louisbarbier/.claude/get-shit-done/workflows/execute-plan.md
@/Users/louisbarbier/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-retrieval/04-RESEARCH.md
@.planning/phases/03-storage/03-01-SUMMARY.md

@src/thehook/storage.py
@src/thehook/capture.py
@src/thehook/config.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD retrieve module — query_sessions, format_context, run_retrieve</name>
  <files>tests/test_retrieve.py, src/thehook/retrieve.py</files>
  <action>
TDD RED-GREEN-REFACTOR cycle for the entire retrieve module.

**RED phase — write failing tests first in `tests/test_retrieve.py`:**

1. `test_query_sessions_returns_documents` (integration):
   - Create a tmp project dir, create `.thehook/chromadb/` directory
   - Call `index_session_file()` to add a test document with known content (e.g., "Use PersistentClient for storage")
   - Call `query_sessions(project_dir, "PersistentClient storage")`
   - Assert result is a non-empty list containing the indexed document text

2. `test_query_sessions_empty_collection` (integration):
   - Create a tmp project dir, create `.thehook/chromadb/` directory
   - Call `get_chroma_client()` and `get_or_create_collection()` to create an empty collection
   - Call `query_sessions(project_dir, "anything")`
   - Assert result is `[]`

3. `test_query_sessions_missing_collection` (unit):
   - Create a tmp project dir with `.thehook/chromadb/` but no collection ever created
   - Call `query_sessions(project_dir, "anything")`
   - Assert result is `[]` (no exception raised)

4. `test_format_context_joins_documents`:
   - Call `format_context(["doc one", "doc two"], token_budget=2000)`
   - Assert result contains both documents separated by `"\n\n---\n\n"`

5. `test_format_context_truncates_to_budget`:
   - Create a list of documents where total chars exceed `token_budget * 4`
   - Call `format_context(documents, token_budget=10)` (10 tokens = 40 chars max)
   - Assert `len(result) <= 40`

6. `test_format_context_empty_list`:
   - Call `format_context([], token_budget=2000)`
   - Assert result is `""`

7. `test_run_retrieve_outputs_valid_json` (unit):
   - Monkeypatch `read_hook_input` to return `{"cwd": str(tmp_path), "session_id": "test"}`
   - Monkeypatch `query_sessions` to return `["doc1", "doc2"]`
   - Capture stdout via `capsys`
   - Call `run_retrieve()`
   - Parse stdout as JSON, assert `output["hookSpecificOutput"]["hookEventName"] == "SessionStart"`
   - Assert `output["hookSpecificOutput"]["additionalContext"]` contains "doc1"

8. `test_run_retrieve_no_output_on_empty` (unit):
   - Monkeypatch `read_hook_input` to return `{"cwd": str(tmp_path)}`
   - Monkeypatch `query_sessions` to return `[]`
   - Capture stdout via `capsys`
   - Call `run_retrieve()`
   - Assert stdout is empty (no JSON printed)

9. `test_run_retrieve_uses_config_token_budget` (unit):
   - Write `thehook.yaml` in tmp_path with `token_budget: 500`
   - Monkeypatch `read_hook_input` to return `{"cwd": str(tmp_path)}`
   - Monkeypatch `query_sessions` to return `["a" * 5000]` (large doc)
   - Capture stdout via `capsys`
   - Call `run_retrieve()`
   - Parse stdout JSON, assert `len(additionalContext) <= 500 * 4`

Run tests: `pytest tests/test_retrieve.py -x` — all must FAIL (module does not exist yet).
Commit: `test(04-01): add failing tests for retrieve module`

**GREEN phase — implement `src/thehook/retrieve.py`:**

```python
"""Retrieval functions for the SessionStart hook and recall CLI."""

from pathlib import Path


def query_sessions(project_dir: Path, query_text: str, n_results: int = 5) -> list[str]:
    """Query ChromaDB for session documents matching query_text.

    Returns [] when collection does not exist, is empty, or on any error.
    Uses lazy chromadb import to avoid ~1s startup cost.
    """
    try:
        from thehook.storage import get_chroma_client, COLLECTION_NAME
        client = get_chroma_client(project_dir)
        collection = client.get_collection(COLLECTION_NAME)
        count = collection.count()
        if count == 0:
            return []
        actual_n = min(n_results, count)
        results = collection.query(query_texts=[query_text], n_results=actual_n)
        return results["documents"][0]
    except Exception:
        return []


def format_context(documents: list[str], token_budget: int = 2000) -> str:
    """Assemble documents into a context string, capped at token_budget tokens.

    Uses chars/4 as token estimate (standard approximation for ASCII markdown).
    Documents are joined with '---' separators. If adding a document would
    exceed the budget, it is trimmed to fit the remaining space.
    """
    max_chars = token_budget * 4
    parts = []
    total = 0
    for doc in documents:
        doc_chars = len(doc)
        if total + doc_chars > max_chars:
            remaining = max_chars - total
            if remaining > 0:
                parts.append(doc[:remaining])
            break
        parts.append(doc)
        total += doc_chars
    return "\n\n---\n\n".join(parts)


def run_retrieve() -> None:
    """SessionStart hook pipeline: read stdin, query ChromaDB, print context JSON.

    Reads hook input from stdin (same format as capture.py), queries ChromaDB
    for relevant session documents, assembles context within the token budget
    from config, and prints valid hookSpecificOutput JSON to stdout.

    Prints nothing if no context is found — Claude Code handles empty stdout.
    All exceptions are caught silently to prevent hook failures.
    """
    import json
    from thehook.capture import read_hook_input
    from thehook.config import load_config

    try:
        hook_input = read_hook_input()
        if not hook_input:
            return

        cwd = hook_input.get("cwd", ".")
        project_dir = Path(cwd)

        config = load_config(project_dir)
        token_budget = config.get("token_budget", 2000)

        documents = query_sessions(
            project_dir,
            query_text="project conventions decisions gotchas architecture",
        )
        context = format_context(documents, token_budget=token_budget)

        if context:
            output = {
                "hookSpecificOutput": {
                    "hookEventName": "SessionStart",
                    "additionalContext": context,
                }
            }
            print(json.dumps(output), flush=True)
    except Exception:
        pass  # Hook must never crash — degrade silently
```

IMPORTANT implementation notes:
- Use `client.get_collection()` (NOT `get_or_create_collection()`) — we do NOT want to create an empty collection on first query. Catch the exception when collection does not exist.
- Use lazy `from thehook.storage import ...` inside `query_sessions()` — consistent with Phase 3 pattern.
- Use `min(n_results, count)` to avoid ChromaDB `ValueError` when n_results exceeds collection count.
- Use `print(json.dumps(output), flush=True)` — flush is critical to prevent dropped output if process is killed.
- The `try/except Exception: pass` in `run_retrieve()` wraps the entire pipeline — hook must NEVER crash.
- Use `read_hook_input()` from `capture.py` — DRY, same stdin JSON shape for all hooks.

Run tests: `pytest tests/test_retrieve.py -x` — all must PASS.
Commit: `feat(04-01): implement retrieve module with query_sessions, format_context, run_retrieve`

**REFACTOR phase (if needed):**
Only if test run reveals cleanup opportunities. Run `pytest tests/ -x` (full suite) to verify no regressions.
  </action>
  <verify>
    <automated>pytest tests/test_retrieve.py -x</automated>
    <manual>Inspect test output — 9 tests pass, all TDD-style with clear names</manual>
    <sampling_rate>run after each TDD phase commit</sampling_rate>
  </verify>
  <done>
    - query_sessions() returns documents from ChromaDB and [] on empty/missing collection
    - format_context() joins documents with separator and truncates to token budget
    - run_retrieve() prints valid hookSpecificOutput JSON with additionalContext to stdout
    - run_retrieve() prints nothing when no context found
    - run_retrieve() reads token_budget from thehook.yaml config
    - Full test suite (54+ existing + 9 new) passes with no regressions
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_retrieve.py -x` — all 9 tests pass
2. `pytest tests/ -x` — full suite passes (54 existing + 9 new = 63+ tests)
3. `python -c "from thehook.retrieve import query_sessions, format_context, run_retrieve"` — all three importable
4. `src/thehook/retrieve.py` exists and contains query_sessions, format_context, run_retrieve
5. `tests/test_retrieve.py` exists and contains 9 test functions
</verification>

<success_criteria>
- retrieve.py module created with query_sessions(), format_context(), run_retrieve()
- All 9 TDD tests pass
- Full test suite passes with no regressions
- Lazy chromadb import pattern maintained
- Empty/missing collection handled gracefully (returns [])
- Token budget enforced via chars/4 approximation
- Valid hookSpecificOutput JSON structure verified by test
</success_criteria>

<output>
After completion, create `.planning/phases/04-retrieval/04-01-SUMMARY.md`
</output>
