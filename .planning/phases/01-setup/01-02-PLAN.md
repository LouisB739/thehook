---
phase: 01-setup
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/thehook/init.py
  - src/thehook/cli.py
  - tests/test_init.py
autonomous: true
requirements:
  - SETUP-01
  - SETUP-02

must_haves:
  truths:
    - "Running `thehook init` in a project root creates `.thehook/` with `sessions/`, `knowledge/`, and `chromadb/` subdirectories"
    - "Running `thehook init` registers SessionEnd and SessionStart hooks in `.claude/settings.local.json`"
    - "Running `thehook init` preserves existing non-hook settings in `.claude/settings.local.json`"
    - "Running `thehook init` in an already-initialized project is safe (idempotent)"
  artifacts:
    - path: "src/thehook/init.py"
      provides: "Init logic — directory creation and hook registration"
      exports: ["init_project"]
    - path: "src/thehook/cli.py"
      provides: "Click CLI with init subcommand wired"
      contains: "@main.command"
    - path: "tests/test_init.py"
      provides: "Init command test coverage"
      min_lines: 60
  key_links:
    - from: "src/thehook/cli.py"
      to: "src/thehook/init.py"
      via: "init command imports and calls init_project()"
      pattern: "from thehook\\.init import init_project"
    - from: "src/thehook/init.py"
      to: ".claude/settings.local.json"
      via: "writes hooks config to settings file"
      pattern: "settings\\.local\\.json"
    - from: "src/thehook/init.py"
      to: ".thehook/"
      via: "creates directory structure"
      pattern: "\\.thehook"
---

<objective>
Implement the `thehook init` command that creates the `.thehook/` directory structure and registers Claude Code lifecycle hooks.

Purpose: This is the core Phase 1 deliverable — a developer runs `thehook init` and their project is fully wired for memory capture and retrieval.
Output: Working `init` subcommand with tests, full Phase 1 functionality complete.
</objective>

<execution_context>
@/Users/louisbarbier/.claude/get-shit-done/workflows/execute-plan.md
@/Users/louisbarbier/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-setup/01-RESEARCH.md
@.planning/phases/01-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement init command with TDD</name>
  <files>
    tests/test_init.py
    src/thehook/init.py
  </files>
  <action>
**RED phase — write tests first in `tests/test_init.py`:**

Test cases (use `tmp_project` fixture):

1. `test_init_creates_thehook_directory_structure` — Call `init_project(tmp_project)`; assert `.thehook/sessions/`, `.thehook/knowledge/` (SINGULAR, not knowledges), `.thehook/chromadb/` all exist as directories.

2. `test_init_registers_session_end_hook` — Call `init_project(tmp_project)`; read `.claude/settings.local.json`; assert `hooks.SessionEnd` exists with a command entry containing `"thehook capture"`, `"async": true`, `"timeout": 120`.

3. `test_init_registers_session_start_hook` — Call `init_project(tmp_project)`; read `.claude/settings.local.json`; assert `hooks.SessionStart` exists with a command entry containing `"thehook retrieve"`, `"timeout": 30`, and `"matcher": "startup"` (NOT "resume" — prevents double-injection per STATE.md concern).

4. `test_init_preserves_existing_settings` — Write `{"some_existing": "setting"}` to `.claude/settings.local.json` before calling `init_project(tmp_project)`; after init, assert `some_existing` key still present alongside `hooks`.

5. `test_init_is_idempotent` — Call `init_project(tmp_project)` twice; assert no errors, directories still exist, hooks still correct.

6. `test_init_creates_claude_dir_if_missing` — Call `init_project(tmp_project)` when `.claude/` does not exist; assert `.claude/` and `settings.local.json` are created.

Run tests — they MUST all fail (module not found).

**GREEN phase — implement `src/thehook/init.py`:**

```python
import json
from pathlib import Path

HOOK_CONFIG = {
    "SessionEnd": [
        {
            "hooks": [
                {
                    "type": "command",
                    "command": "thehook capture",
                    "async": True,
                    "timeout": 120,
                }
            ]
        }
    ],
    "SessionStart": [
        {
            "matcher": "startup",
            "hooks": [
                {
                    "type": "command",
                    "command": "thehook retrieve",
                    "timeout": 30,
                }
            ]
        }
    ],
}

def init_project(project_dir: Path) -> None:
    # Create .thehook directory structure
    thehook_dir = project_dir / ".thehook"
    (thehook_dir / "sessions").mkdir(parents=True, exist_ok=True)
    (thehook_dir / "knowledge").mkdir(parents=True, exist_ok=True)
    (thehook_dir / "chromadb").mkdir(parents=True, exist_ok=True)

    # Register Claude Code hooks
    claude_dir = project_dir / ".claude"
    claude_dir.mkdir(exist_ok=True)
    settings_path = claude_dir / "settings.local.json"

    settings = {}
    if settings_path.exists():
        settings = json.loads(settings_path.read_text())

    settings["hooks"] = HOOK_CONFIG

    with open(settings_path, "w") as f:
        json.dump(settings, f, indent=2)
```

Run tests — they MUST all pass.

**CRITICAL naming:** Directory is `knowledge/` (singular) per SETUP-02. NOT `knowledges/`.
**CRITICAL matcher:** SessionStart hook has `"matcher": "startup"` to avoid double-injection on resume.
  </action>
  <verify>
    <automated>.venv/bin/pytest tests/test_init.py -x -v</automated>
    <manual>All 6 init tests pass; directory names are singular; matcher is "startup"</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>
    - All 6 init tests pass
    - `.thehook/sessions/`, `.thehook/knowledge/`, `.thehook/chromadb/` created (SETUP-02)
    - Hooks registered in `.claude/settings.local.json` (SETUP-01)
    - Existing settings preserved during hook registration
    - SessionStart matcher set to "startup" only
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire init into CLI and run end-to-end verification</name>
  <files>
    src/thehook/cli.py
    tests/test_init.py
  </files>
  <action>
1. Update `src/thehook/cli.py` to add the `init` subcommand:

```python
import click
from pathlib import Path

@click.group()
@click.version_option()
def main():
    """TheHook - Self-improving long-term memory for AI coding agents."""
    pass

@main.command()
@click.option("--path", default=".", help="Project root directory")
def init(path):
    """Initialize TheHook in the current project."""
    project_dir = Path(path).resolve()
    from thehook.init import init_project
    init_project(project_dir)
    click.echo(f"TheHook initialized in {project_dir / '.thehook'}")
    click.echo("Hooks registered in .claude/settings.local.json")
```

2. Add CLI-level integration tests to `tests/test_init.py`:

- `test_cli_init_creates_structure` — Use `CliRunner` to invoke `main` with `["init", "--path", str(tmp_project)]`; assert `exit_code == 0`, output contains "TheHook initialized", and `.thehook/` subdirectories exist.

- `test_cli_init_shows_confirmation` — Invoke via `CliRunner`; assert output contains "Hooks registered in .claude/settings.local.json".

- `test_cli_init_default_path` — Invoke `init` without `--path` inside `CliRunner` with `mix_stderr=False`; verify it uses the current directory.

3. Run the full test suite:
```bash
.venv/bin/pytest tests/ -x -v
```

All tests from both Plan 01 (config) and Plan 02 (init) must pass together.
  </action>
  <verify>
    <automated>.venv/bin/pytest tests/ -x -v</automated>
    <manual>Full test suite passes; CLI init command works end-to-end via CliRunner</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>
    - `thehook init --path /some/dir` creates directory structure and registers hooks
    - CLI output confirms initialization and hook registration
    - Full test suite passes (config + init tests)
    - Phase 1 success criteria 1-4 all achievable
  </done>
</task>

</tasks>

<verification>
Phase 1 success criteria validation (from ROADMAP.md):

1. **`thehook init` creates `.thehook/` with subdirectories:**
   `pytest tests/test_init.py -x -k "directory_structure" -v`

2. **`thehook init` registers hooks in settings and shows confirmation:**
   `pytest tests/test_init.py -x -k "registers" -v`

3. **TheHook works without any `thehook.yaml` file:**
   `pytest tests/test_config.py -x -k "no_yaml" -v`

4. **Custom `thehook.yaml` values are loaded and applied:**
   `pytest tests/test_config.py -x -k "partial or full" -v`

5. **Full suite green:**
   `pytest tests/ -x -v`
</verification>

<success_criteria>
- `thehook init` creates `.thehook/sessions/`, `.thehook/knowledge/`, `.thehook/chromadb/` (SETUP-02)
- `thehook init` writes SessionEnd + SessionStart hooks to `.claude/settings.local.json` (SETUP-01)
- Existing settings in `.claude/settings.local.json` are preserved
- SessionStart hook uses `"matcher": "startup"` to prevent double-injection
- CLI shows confirmation messages after init
- All tests pass: `pytest tests/ -x -v`
</success_criteria>

<output>
After completion, create `.planning/phases/01-setup/01-02-SUMMARY.md`
</output>
