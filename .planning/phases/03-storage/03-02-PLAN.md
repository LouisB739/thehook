---
phase: 03-storage
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - pyproject.toml
  - src/thehook/cli.py
  - src/thehook/capture.py
  - tests/test_capture.py
autonomous: true
requirements:
  - STOR-01
  - STOR-03
  - STOR-05

must_haves:
  truths:
    - "run_capture() calls index_session_file() after every successful write_session_file()"
    - "ChromaDB failure in run_capture() is swallowed — capture pipeline never crashes due to indexing"
    - "thehook reindex CLI command exists and prints indexed count"
    - "chromadb>=1.0 is declared in pyproject.toml dependencies"
  artifacts:
    - path: "pyproject.toml"
      provides: "chromadb dependency declaration"
      contains: "chromadb>=1.0"
    - path: "src/thehook/cli.py"
      provides: "reindex CLI subcommand"
      contains: "def reindex"
    - path: "src/thehook/capture.py"
      provides: "ChromaDB indexing call after session write"
      contains: "index_session_file"
  key_links:
    - from: "src/thehook/capture.py"
      to: "src/thehook/storage.py"
      via: "import index_session_file inside run_capture()"
      pattern: "from thehook\\.storage import index_session_file"
    - from: "src/thehook/cli.py"
      to: "src/thehook/storage.py"
      via: "lazy import of reindex inside CLI command"
      pattern: "from thehook\\.storage import reindex"
---

<objective>
Wire ChromaDB indexing into the capture pipeline and add the reindex CLI command.

Purpose: Connect the storage module (built in 03-01) into the existing capture pipeline so every session is automatically indexed, and expose `thehook reindex` as a user-facing CLI command. Also add `chromadb>=1.0` to project dependencies.

Output: Updated `capture.py`, `cli.py`, `pyproject.toml`, and test coverage for the integration points.
</objective>

<execution_context>
@/Users/louisbarbier/.claude/get-shit-done/workflows/execute-plan.md
@/Users/louisbarbier/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-storage/03-RESEARCH.md
@.planning/phases/03-storage/03-01-SUMMARY.md
@src/thehook/capture.py
@src/thehook/cli.py
@src/thehook/storage.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add chromadb dependency and wire reindex CLI command</name>
  <files>pyproject.toml, src/thehook/cli.py</files>
  <action>
    1. In `pyproject.toml`, add `"chromadb>=1.0"` to the `dependencies` list (after `"pyyaml>=6.0"`).

    2. In `src/thehook/cli.py`, add a `reindex` subcommand following the existing pattern (lazy import inside command function):

    ```python
    @main.command()
    @click.option("--path", default=".", help="Project root directory")
    def reindex(path):
        """Rebuild the ChromaDB index from all session markdown files."""
        from thehook.storage import reindex as do_reindex
        project_dir = Path(path).resolve()
        count = do_reindex(project_dir)
        click.echo(f"Reindexed {count} session files.")
    ```

    Follow the exact same pattern as the existing `init` command: `@click.option("--path")`, resolve to absolute, lazy import, call, echo result.
  </action>
  <verify>
    <automated>python -c "from thehook.cli import main; print('CLI imports OK')" && python -c "import tomllib; d = tomllib.load(open('pyproject.toml', 'rb')); assert 'chromadb>=1.0' in d['project']['dependencies'], 'chromadb not in deps'; print('Dep OK')"</automated>
  </verify>
  <done>
    - `chromadb>=1.0` appears in pyproject.toml dependencies
    - `thehook reindex` is a registered CLI subcommand
    - CLI module imports cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate index_session_file into run_capture and add tests</name>
  <files>src/thehook/capture.py, tests/test_capture.py</files>
  <action>
    1. In `src/thehook/capture.py`, modify `run_capture()` to call `index_session_file()` after every successful `write_session_file()` call. There are two write paths in run_capture:

    **Path A — successful extraction (line ~290):**
    After `write_session_file(sessions_dir, session_id, transcript_path, result)`, add:
    ```python
    try:
        from thehook.storage import index_session_file
        project_dir = Path(cwd)
        index_session_file(project_dir, session_path)
    except Exception:
        pass  # ChromaDB failure must never break capture pipeline
    ```
    Note: `write_session_file` returns the session_path, so capture it: `session_path = write_session_file(...)`.

    **Path B — stub write (line ~292):**
    After `write_stub_summary(...)`, add the same try/except pattern. Stubs also get indexed — they contain at least a summary line and metadata. Capture the return: `session_path = write_stub_summary(...)`.

    **Path C — empty transcript stub (line ~282):**
    After `write_stub_summary(sessions_dir, session_id, transcript_path, 0, reason="empty transcript")`, add the same try/except pattern. Capture the return value.

    **CRITICAL:** Import `index_session_file` INSIDE the try block (lazy import). ChromaDB is a heavy dependency. If chromadb is not installed, the import itself fails — the except catches it and capture proceeds normally.

    **CRITICAL:** The `project_dir` for index_session_file is `Path(cwd)` — the same cwd already extracted from hook_input at the top of run_capture. Do NOT use `os.getcwd()`.

    2. In `tests/test_capture.py`, add tests for the integration:

    - `test_run_capture_calls_index_session_file`: Mock `index_session_file` and verify it is called after successful extraction. Use existing test patterns: mock `read_hook_input`, `parse_transcript`, `run_claude_extraction` to return valid data; mock `write_session_file` to return a Path; assert `index_session_file` was called with the project_dir and session_path.

    - `test_run_capture_index_failure_does_not_crash`: Mock `index_session_file` to raise an exception. Verify `run_capture()` completes without raising — the exception is swallowed.

    - `test_run_capture_stub_also_indexes`: Mock `index_session_file`, set up extraction to return None (triggering stub path). Verify `index_session_file` is called with the stub file path.

    - `test_cli_reindex_command`: Use Click's CliRunner to invoke `thehook reindex --path {tmp_path}`. Mock `do_reindex` to return 3. Assert output contains "Reindexed 3 session files."
  </action>
  <verify>
    <automated>pytest tests/test_capture.py tests/test_storage.py -x -v</automated>
  </verify>
  <done>
    - run_capture() calls index_session_file after every write (extraction success, stub on timeout, stub on empty transcript)
    - ChromaDB exceptions in run_capture are caught and swallowed — pipeline never crashes
    - Import of storage module is lazy (inside try block) — capture works even if chromadb is not installed
    - 4 new integration tests pass
    - All existing capture tests still pass
  </done>
</task>

</tasks>

<verification>
pytest tests/ -x -v
All existing tests (40+) pass, plus new integration tests for storage wiring.
Full pipeline: run_capture -> write_session_file -> index_session_file (with graceful degradation on ChromaDB failure).
CLI: `thehook reindex --path .` prints count of indexed files.
</verification>

<success_criteria>
- chromadb>=1.0 in pyproject.toml
- thehook reindex CLI command registered and functional
- run_capture() indexes every session file (success, timeout stub, empty transcript stub)
- ChromaDB errors never crash the capture pipeline
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/03-storage/03-02-SUMMARY.md`
</output>
