---
phase: 03-storage
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/thehook/storage.py
  - tests/test_storage.py
autonomous: true
requirements:
  - STOR-02
  - STOR-03
  - STOR-04
  - STOR-05

must_haves:
  truths:
    - "get_chroma_client returns a PersistentClient pointing at .thehook/chromadb/"
    - "index_session_file parses frontmatter and upserts document with session_id, type, and timestamp metadata"
    - "index_session_file silently skips malformed files (no frontmatter delimiters)"
    - "reindex drops and recreates the collection, then re-adds all session markdown files"
    - "reindex returns 0 gracefully when the sessions directory is missing or empty"
    - "reindex skips files with empty body after frontmatter"
  artifacts:
    - path: "src/thehook/storage.py"
      provides: "ChromaDB indexing functions"
      exports: ["COLLECTION_NAME", "get_chroma_client", "index_session_file", "reindex"]
    - path: "tests/test_storage.py"
      provides: "TDD tests for storage module"
      min_lines: 80
  key_links:
    - from: "src/thehook/storage.py"
      to: "chromadb.PersistentClient"
      via: "get_chroma_client()"
      pattern: "chromadb\\.PersistentClient"
    - from: "src/thehook/storage.py"
      to: "collection.upsert"
      via: "index_session_file()"
      pattern: "collection\\.upsert"
    - from: "src/thehook/storage.py"
      to: "client.delete_collection"
      via: "reindex()"
      pattern: "client\\.delete_collection"
---

<objective>
Build the storage module with ChromaDB indexing functions using TDD.

Purpose: Create `storage.py` with `get_chroma_client()`, `index_session_file()`, and `reindex()` — the core functions that index session markdown files into ChromaDB. All three functions have well-defined inputs and outputs suitable for RED-GREEN-REFACTOR cycles.

Output: Working, tested `src/thehook/storage.py` and `tests/test_storage.py`.
</objective>

<execution_context>
@/Users/louisbarbier/.claude/get-shit-done/workflows/execute-plan.md
@/Users/louisbarbier/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-storage/03-RESEARCH.md
@src/thehook/capture.py
@tests/conftest.py
</context>

<feature>
  <name>ChromaDB storage indexing</name>
  <files>src/thehook/storage.py, tests/test_storage.py</files>
  <behavior>
    Three functions with defined I/O:

    1. `get_chroma_client(project_dir: Path) -> chromadb.ClientAPI`
       - Input: project_dir (Path)
       - Output: PersistentClient with path=str(project_dir / ".thehook" / "chromadb")
       - Module constant: COLLECTION_NAME = "thehook_sessions"

    2. `index_session_file(project_dir: Path, session_path: Path) -> None`
       - Input: project root dir, path to a session .md file with YAML frontmatter
       - Behavior: Parses frontmatter via `content.split("---", 2)` + `yaml.safe_load()`, extracts body, calls `collection.upsert(documents=[body], metadatas=[{session_id, type: "session", timestamp}], ids=[session_id])`
       - Uses `upsert` (not `add`) to be idempotent on re-capture
       - Silently returns on malformed files (< 3 parts after split)
       - Uses filename stem as fallback ID if frontmatter session_id is missing: `fm.get("session_id") or session_path.stem`
       - Skips files with empty body (`body.strip()` is falsy)

    3. `reindex(project_dir: Path) -> int`
       - Input: project root dir
       - Output: int — count of files successfully indexed
       - Behavior: Deletes existing collection (try/except pass), creates fresh collection, globs `.thehook/sessions/*.md`, parses each file's frontmatter + body, batch `collection.add()` all valid documents, returns count
       - Returns 0 if sessions dir does not exist
       - Returns 0 if sessions dir is empty
       - Skips files with empty body

    Test cases:
    - `test_get_chroma_client_path`: Client path points at .thehook/chromadb/
    - `test_index_session_file_adds_document`: After indexing, collection contains 1 document with correct metadata
    - `test_index_session_file_upsert_idempotent`: Calling index twice for same file does not raise, collection still has 1 document
    - `test_index_session_file_skips_malformed`: File without frontmatter delimiters is silently skipped
    - `test_index_session_file_skips_empty_body`: File with frontmatter but empty body is skipped
    - `test_index_session_file_uses_filename_fallback`: File with no session_id in frontmatter uses stem as ID
    - `test_reindex_drops_and_recreates`: Pre-existing collection is dropped; after reindex, collection has exactly N documents matching N valid files
    - `test_reindex_empty_dir`: Returns 0, no error, when sessions dir has no .md files
    - `test_reindex_missing_dir`: Returns 0, no error, when sessions dir does not exist
    - `test_reindex_skips_empty_body`: Files with empty body after frontmatter are not indexed

    Testing strategy: Use `chromadb.EphemeralClient()` in tests to avoid disk I/O and model download delays. Monkeypatch `get_chroma_client` to return an EphemeralClient when testing `index_session_file` and `reindex`. For `test_get_chroma_client_path`, test the path construction logic (verify str(path) is passed) without needing a real PersistentClient.
  </behavior>
  <implementation>
    Create `src/thehook/storage.py` with:
    - `COLLECTION_NAME = "thehook_sessions"` module constant
    - `get_chroma_client(project_dir)` — returns `chromadb.PersistentClient(path=str(project_dir / ".thehook" / "chromadb"))`
    - `index_session_file(project_dir, session_path)` — parse frontmatter with yaml.safe_load, upsert to collection
    - `reindex(project_dir)` — delete_collection, get_or_create_collection, glob + batch add

    Import chromadb lazily inside each function body (chromadb is a heavy import ~1s; keep module-level imports light).

    Use `yaml.safe_load` for frontmatter (PyYAML already a dep). Use `collection.upsert()` in index_session_file (idempotent). Use `collection.add()` in reindex (no duplicates possible after drop). Use filename stem as fallback ChromaDB ID per research recommendation.
  </implementation>
</feature>

<verification>
pytest tests/test_storage.py -x -v
</verification>

<success_criteria>
- All 10 test cases pass
- `storage.py` exports COLLECTION_NAME, get_chroma_client, index_session_file, reindex
- No chromadb import at module level in storage.py (lazy import inside functions)
- upsert used in index_session_file, add used in reindex
- Malformed files and empty bodies silently skipped in both index_session_file and reindex
</success_criteria>

<output>
After completion, create `.planning/phases/03-storage/03-01-SUMMARY.md`
</output>
