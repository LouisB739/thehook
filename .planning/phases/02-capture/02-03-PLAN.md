---
phase: 02-capture
plan: 03
type: tdd
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/thehook/capture.py
  - src/thehook/cli.py
  - tests/test_capture.py
autonomous: true
requirements: [CAPT-04, CAPT-06]

must_haves:
  truths:
    - "The extraction prompt contains 'conventions' and 'decisions' as target knowledge types"
    - "The extraction prompt does NOT contain 'observations' — it targets specific knowledge, not raw capture"
    - "run_capture reads hook input from stdin, parses transcript, runs extraction, and writes a session file"
    - "When extraction succeeds, the session file contains SUMMARY, CONVENTIONS, DECISIONS, and GOTCHAS sections"
    - "When extraction fails or times out, a stub summary is written with transcript metadata"
    - "The CLI capture command is callable as thehook capture"
  artifacts:
    - path: "src/thehook/capture.py"
      provides: "Complete capture pipeline with extraction prompt and orchestration"
      exports: ["run_capture", "EXTRACTION_PROMPT_TEMPLATE"]
    - path: "src/thehook/cli.py"
      provides: "capture CLI subcommand"
      contains: "def capture"
    - path: "tests/test_capture.py"
      provides: "Full test coverage for capture pipeline"
      contains: "test_run_capture"
  key_links:
    - from: "src/thehook/cli.py::capture"
      to: "src/thehook/capture.py::run_capture"
      via: "CLI command calls run_capture"
      pattern: "from thehook.capture import run_capture"
    - from: "src/thehook/capture.py::run_capture"
      to: "src/thehook/capture.py::parse_transcript"
      via: "Orchestration calls parsing"
      pattern: "parse_transcript"
    - from: "src/thehook/capture.py::run_capture"
      to: "src/thehook/capture.py::run_claude_extraction"
      via: "Orchestration calls extraction"
      pattern: "run_claude_extraction"
    - from: "src/thehook/capture.py::run_capture"
      to: "src/thehook/capture.py::write_session_file"
      via: "Orchestration writes output"
      pattern: "write_session_file"
---

<objective>
Wire the extraction prompt and capture orchestration — completing the full SessionEnd capture pipeline.

Purpose: This is the integration layer that connects parsing (Plan 01) to extraction (Plan 02) into a single `run_capture` function called by the CLI. The extraction prompt is critical — it must target conventions and architecture decisions specifically (CAPT-06), not raw observations.
Output: Complete `thehook capture` command that reads stdin hook input, parses the transcript, extracts structured knowledge via `claude -p`, and writes a session markdown file (or stub on failure).
</objective>

<execution_context>
@/Users/louisbarbier/.claude/get-shit-done/workflows/execute-plan.md
@/Users/louisbarbier/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-capture/02-RESEARCH.md
@.planning/phases/02-capture/02-01-SUMMARY.md
@.planning/phases/02-capture/02-02-SUMMARY.md
@src/thehook/capture.py
@src/thehook/cli.py
@tests/test_capture.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for extraction prompt, run_capture orchestration, and CLI command</name>
  <files>tests/test_capture.py</files>
  <action>
Add the following failing tests to `tests/test_capture.py`. Import `run_capture`, `EXTRACTION_PROMPT_TEMPLATE` from `thehook.capture`.

**Extraction prompt tests (CAPT-06):**

1. `test_extraction_prompt_targets_conventions`:
   - Assert `"conventions"` (case-insensitive) appears in `EXTRACTION_PROMPT_TEMPLATE`
   - Assert `"decisions"` (case-insensitive) appears in `EXTRACTION_PROMPT_TEMPLATE`

2. `test_extraction_prompt_excludes_observations`:
   - Assert `"observations"` does NOT appear in `EXTRACTION_PROMPT_TEMPLATE` (case-insensitive)
   - This ensures the prompt targets specific knowledge types per CAPT-06

3. `test_extraction_prompt_has_all_four_sections`:
   - Assert `EXTRACTION_PROMPT_TEMPLATE` contains all four section headers: `## SUMMARY`, `## CONVENTIONS`, `## DECISIONS`, `## GOTCHAS`

**run_capture orchestration tests (CAPT-04, integration with mocks):**

4. `test_run_capture_success_writes_session_file(tmp_project, monkeypatch)`:
   - Create the sample transcript fixture file at `tmp_project / "transcript.jsonl"` (copy content from `tests/fixtures/sample_transcript.jsonl` or write minimal valid JSONL inline)
   - Create `tmp_project / ".thehook" / "sessions"` directory
   - Monkeypatch `sys.stdin` with StringIO containing `{"session_id": "test123", "transcript_path": "<path to fixture>", "cwd": "<tmp_project>"}`
   - Monkeypatch `run_claude_extraction` to return `"## SUMMARY\nTest session.\n\n## CONVENTIONS\n- Use pytest\n\n## DECISIONS\n- Chose Click\n\n## GOTCHAS\nNone this session."`
   - Call `run_capture()`
   - Assert a `.md` file exists in `tmp_project / ".thehook" / "sessions"` directory
   - Read the file, assert it contains `session_id: test123` and `## SUMMARY` and `## CONVENTIONS`

5. `test_run_capture_extraction_failure_writes_stub(tmp_project, monkeypatch)`:
   - Same setup as above but monkeypatch `run_claude_extraction` to return `None`
   - Call `run_capture()`
   - Assert a `.md` file exists in sessions dir
   - Read the file, assert it contains `Extraction timeout` (stub content) and `session_id: test123`

6. `test_run_capture_empty_transcript_writes_stub(tmp_project, monkeypatch)`:
   - Monkeypatch stdin with valid JSON but `transcript_path` pointing to a nonexistent file
   - Call `run_capture()`
   - Assert a stub file was written with "empty transcript" in content

7. `test_run_capture_invalid_stdin_returns_silently(monkeypatch)`:
   - Monkeypatch `sys.stdin` with StringIO containing `"not json"`
   - Call `run_capture()` — should not raise, should return silently

**CLI integration test:**

8. `test_cli_capture_command_exists`:
   - Import `main` from `thehook.cli`
   - Use Click's `CliRunner` to invoke `main` with `["capture", "--help"]`
   - Assert exit code 0 and output contains "capture" or "Extract" (help text)

Run: `pytest tests/test_capture.py -v -k "prompt or run_capture or cli_capture"` — ALL must FAIL.
  </action>
  <verify>
    <automated>cd /Users/louisbarbier/thehook && pytest tests/test_capture.py -v -k "prompt or run_capture or cli_capture" 2>&1 | tail -5</automated>
    <manual>All 8 new tests fail; existing 18 tests still pass</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>8 new failing tests for prompt, orchestration, and CLI; existing 18 tests unaffected</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement extraction prompt, run_capture orchestration, and CLI capture command</name>
  <files>
    src/thehook/capture.py
    src/thehook/cli.py
  </files>
  <action>
1. Add `EXTRACTION_PROMPT_TEMPLATE` to `src/thehook/capture.py`:
   - Follow Pattern 4 from 02-RESEARCH.md exactly
   - Must contain `{transcript_text}` placeholder
   - Must contain section headers: `## SUMMARY`, `## CONVENTIONS`, `## DECISIONS`, `## GOTCHAS`
   - Must mention "conventions" and "decisions" as extraction targets
   - Must NOT contain the word "observations" anywhere
   - Include instruction: "Only include concrete conventions" and "Only include decisions that are specific to this project"
   - Include instruction: "If a section has nothing to report, write 'None this session.'"

2. Add `run_capture()` function to `src/thehook/capture.py`:
   - Follow the Full Capture Command Flow from 02-RESEARCH.md (Pattern: Code Examples section)
   - Read hook input from stdin via `read_hook_input()`
   - If hook input is empty (bad JSON), return silently
   - Extract `session_id`, `transcript_path`, `cwd` from hook input
   - Use `cwd` from hook input as project_dir (Pitfall 6 from research: hook may run from different cwd)
   - Set `sessions_dir = Path(cwd) / ".thehook" / "sessions"`
   - Call `parse_transcript(transcript_path)` to get messages
   - If 0 messages, call `write_stub_summary(..., reason="empty transcript")` and return
   - Call `assemble_transcript_text(messages, max_chars=MAX_TRANSCRIPT_CHARS)` to build text
   - Format prompt: `EXTRACTION_PROMPT_TEMPLATE.format(transcript_text=transcript_text)`
   - Call `run_claude_extraction(prompt)` to get result
   - If result is truthy, call `write_session_file(sessions_dir, session_id, transcript_path, result)`
   - If result is falsy (None or empty), call `write_stub_summary(sessions_dir, session_id, transcript_path, len(messages), reason="timeout")`

3. Add `capture` command to `src/thehook/cli.py`:
   - Add `@main.command()` decorated function `capture()` below existing `init` command
   - Docstring: `"""Extract knowledge from the completed session transcript (called by SessionEnd hook)."""`
   - Body: `from thehook.capture import run_capture` then `run_capture()`
   - No arguments or options needed — input comes from stdin

Run `pytest tests/test_capture.py -x -v` — ALL 26 tests must PASS.
Then run `pytest tests/ -x -q` — full suite must pass.
  </action>
  <verify>
    <automated>cd /Users/louisbarbier/thehook && pytest tests/ -x -v</automated>
    <manual>All 26 capture tests + all existing tests pass; thehook capture --help works</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Complete capture pipeline works end-to-end: stdin -> parse -> extract -> write; CLI command registered; all tests pass</done>
</task>

</tasks>

<verification>
- `pytest tests/test_capture.py -v` — all 26 tests pass
- `pytest tests/ -x -q` — full suite (14 existing + 26 capture = ~40 total) passes
- `thehook capture --help` — shows help text
- `python -c "from thehook.capture import run_capture, EXTRACTION_PROMPT_TEMPLATE; assert 'conventions' in EXTRACTION_PROMPT_TEMPLATE.lower(); assert 'observations' not in EXTRACTION_PROMPT_TEMPLATE.lower()"` — prompt targeting verified
</verification>

<success_criteria>
- EXTRACTION_PROMPT_TEMPLATE targets conventions and decisions, excludes observations
- run_capture reads stdin, parses transcript, extracts knowledge, writes session file
- Graceful degradation: stub written on extraction failure, empty transcript, bad stdin
- CLI capture command registered and callable
- All tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-capture/02-03-SUMMARY.md`
</output>
